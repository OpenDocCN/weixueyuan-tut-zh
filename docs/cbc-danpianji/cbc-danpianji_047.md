# 单片机中断的优先级

中断优先级的内容，大家先通过我的介绍大概了解一下即可，后边实际应用的时候我们再详细理解。

在讲中断产生背景的时候，我们仅仅讲了看电视和烧水的例子，但是实际生活当中还有更复杂的，比如我正在看电视，这个时候来电话了，我要进入接电话的“中断”程序当中去，就在接电话的同时，听到了水开的声音，水开的“中断”也发生了，我们就必须要放下手上的电话，先把煤气关掉，然后再回来听电话，最后听完了电话再看电视，这里就产生了一个优先级的问题。

还有一种情况，我们在看电视的时候，这个时候听到水开的声音，水开的“中断”发生了，我们要进入关煤气的“中断”程序当中，而在关煤气的同时，电话声音响了，而这个时候，我们的处理方式是先把煤气关闭，再去接听电话，最后再看电视。

从这两个过程中，我们可以得到一个结论，就是最最紧急的事情，一旦发生后，我们不管当时处在哪个“程序”当中，我们必须先去处理最最紧急的事情，处理完毕后再去解决其它事情。在我们的单片机程序当中有时候也是这样的，有一般紧急的中断，有特别紧急的中断，这取决于具体的系统设计，这就涉及到中断优先级和中断嵌套的概念，在本章节我们先简单介绍一下相关寄存器，不做例程说明。

中断优先级有两种，一种是抢占优先级，一种是固有优先级，先介绍抢占优先级。来看表 6-4 和表 6-5。

表 6-4 IP——中断优先级寄存器的位分配（地址 0xB8、可位寻址）

| 位 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| 符号 | -- | -- | PT2 | PS | PT1 | PX1 | PT0 | PX0 |
| 复位值 | -- | -- | 0 | 0 | 0 | 0 | 0 | 0 |

表 6-5 IP——中断优先级寄存器的位描述

| 位 | 符号 | 描述 |
| 7 | -- | 保留 |
| 6 | -- | 保留 |
| 5 | PT2 | 定时器 2 中断优先级控制位 |
| 4 | PS | 串口中断优先级控制位 |
| 3 | PT1 | 定时器 1 中断优先级控制位 |
| 2 | PX1 | 外部中断 1 中断优先级控制位 |
| 1 | PT0 | 定时器 0 中断优先级控制位 |
| 0 | PX0 | 外部中断 0 中断优先级控制位 |

IP 这个寄存器的每一位，表示对应中断的抢占优先级，每一位的复位值都是 0，当我们把某一位设置为 1 的时候，这一位的优先级就比其它位的优先级高了。比如我们设置了 PT0 位为 1 后，当单片机在主循环或者任何其它中断程序中执行时，一旦定时器 T0 发生中断，作为更高的优先级，程序马上就会跑到 T0 的中断程序中来执行。反过来，当单片机正在 T0 中断程序中执行时，如果有其它中断发生了，还是会继续执行 T0 中断程序，直到把 T0 中的中断程序执行完毕以后，才会去执行其它中断程序。

当进入低优先级中断中执行时，如又发生了高优先级的中断，则立刻进入高优先级中断执行，处理完高优先级级中断后，再返回处理低优先级中断，这个过程就叫做中断嵌套，也称为抢占。所以抢占优先级的概念就是，优先级高的中断可以打断优先级低的中断的执行，从而形成嵌套。当然反过来，优先级低的中断是不能打断优先级高的中断的。

那么既然有抢占优先级，自然就也有非抢占优先级了，也称为固有优先级。在表 6-3 中的最后一列给出的就是固有优先级，请注意，在中断优先级的编号中，一般都是数字越小优先级越高。从表中可以看到一共有 1～6 共 6 级的优先级，这里的优先级与抢占优先级的一个不同点就是，它不具有抢占的特性，也就是说即使在低优先级中断执行过程中又发生了高优先级的中断，那么这个高优先级的中断也只能等到低优先级中断执行完后才能得到响应。既然不能抢占，那么这个优先级有什么用呢？

答案是多个中断同时存在时的仲裁。比如说有多个中断同时发生了，当然实际上发生这种情况的概率很低，但另外一种情况就常见的多了，那就是出于某种原因我们暂时关闭了总中断，即 EA=0，执行完一段代码后又重新使能了总中断，即 EA=1，那么在这段时间里就很可能有多个中断都发生了，但因为总中断是关闭的，所以它们当时都得不到响应，而当总中断再次使能后，它们就会在同时请求响应了，很明显，这时也必需有个先后顺序才行，这就是非抢占优先级的作用了——如表 6-3 中，谁优先级最高先响应谁，然后按编号排队，依次得到响应。

抢占优先级和非抢占优先级的协同，可以使单片机中断系统有条不紊的工作，既不会无休止的嵌套，又可以保证必要时紧急任务得到优先处理。在后续的学习过程中，中断系统会与我们如影随形，处处都有它的身影，随着学习的深入，相信你对它的理解也会更加的深入。