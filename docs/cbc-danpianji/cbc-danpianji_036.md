# 单片机中定时器的应用

了解了定时器相关的寄存器，那么我们下面就来做一个定时器的程序，巩固一下我们学到的内容。我们这节课的程序先使用定时器 0，在使用定时器的时候，需要以下几个步骤：

第一步：设置特殊功能寄存器 TMOD，配置好工作模式。

第二步：设置计数寄存器 TH0 和 TL0 的初值。

第三步：设置 TCON，通过 TR0 置 1 来让定时器开始计数。

第四步：判断 TCON 寄存器的 TF0 位，监测定时器溢出情况。

写程序之前，我们要先来学会计算如何用定时器定时时间。我们的晶振是 11.0592M，时钟周期就是 1/11059200，机器周期是 12/11059200，假如要定时 20ms，就是 0.02 秒，要经过 x 个机器周期得到 0.02 秒，我们来算一下 x*12/11059200=0.02，得到 x= 18432。16 位定时器的溢出值是 65536（因 65535 再加 1 才是溢出），于是我们就可以这样操作，先给 TH0 和 TL0 一个初始值，让它们经过 18432 个机器周期后刚好达到 65536，也就是溢出，溢出后可以通过检测 TF0 的值得知，就刚好是 0.02 秒。那么初值 y = 65536 - 18432 = 47104，转成 16 进制就是 0xB800，也就是 TH0 = 0xB8，TL0 = 0x00。

这样 0.02 秒的定时我们就做出来了，细心的同学会发现，如果初值直接给一个 0x0000，一直到 65536 溢出，定时器定时值最大也就是 71ms 左右，那么我们想定时更长时间怎么办呢？用你小学学过的逻辑，倍数关系就可以解决此问题。

好了，我们下面就用程序来实现这个功能。

```
#include <reg52.h>

sbit LED = P0⁰;
sbit ADDR0 = P1⁰;
sbit ADDR1 = P1¹;
sbit ADDR2 = P1²;
sbit ADDR3 = P1³;
sbit ENLED = P1⁴;

void main(){
    unsigned char cnt = 0;  //定义一个计数变量，记录 T0 溢出次数

    ENLED = 0;  //使能 U3，选择独立 LED
    ADDR3 = 1;
    ADDR2 = 1;
    ADDR1 = 1;
    ADDR0 = 0;
    TMOD = 0x01;  //设置 T0 为模式 1
    TH0 = 0xB8;  //为 T0 赋初值 0xB800
    TL0 = 0x00;
    TR0 = 1;  //启动 T0

    while (1){
        if (TF0 == 1){  //判断 T0 是否溢出
            TF0 = 0;  //T0 溢出后，清零中断标志
            TH0 = 0xB8;  //并重新赋初值
            TL0 = 0x00;
            cnt++;  //计数值自加 1
            if (cnt >= 50){  //判断 T0 溢出是否达到 50 次
                cnt = 0;  //达到 50 次后计数值清零
                LED = ~LED; //LED 取反：0-->1、1-->0
            }
        }
    }
}
```

程序中都写了注释，结合前几章学的内容，自己分析一下，不难理解。本程序实现的结果是开发板上最右边的小灯点亮一秒，熄灭一秒，也就是以 0.5Hz 的频率进行闪烁。